# Определение unicast-адресов резолверов НСДИ через анализ логов авторитетного DNS-сервера

Задача: определение unicast-адресов резолверов Национальной системы доменных имен по логам.

## Введение

Национальная система доменных имён (НСДИ) использует публичные рекурсивные резолверы, доступные по anycast-адресам:

- IPv4: `195.208.4.1`, `195.208.5.1`
- IPv6: `2a0c:a9c7:8::1`, `2a0c:a9c7:9::1`

За этими адресами скрываются реальные физические серверы, у каждого из которых есть свой **unicast-IP**.  
Чтобы выявить эти адреса, мы анализируем логи авторитетного DNS-сервера(наш BIND).

---

## Алгоритм

### 1. Сбор данных

1. Настроить авторитетный DNS-сервер
2. Включить логирование запросов (`query.log`).
3. Собрать логи, где фиксируются IP-адреса резолверов, которые обращались к серверу.

### 2. Известные диапазоны НСДИ

По данным Минцифры и RIPE, резолверы НСДИ анонсируются из ASN **41740 (NDNS)** и используют следующие подсети:

- `193.232.147.0/24`
- `193.232.253.0/24`
- `195.208.4.0/24`
- `195.208.5.0/24`
- `195.208.6.0/24`
- `195.208.7.0/24`
- `193.223.132.0/24` (наблюдаемый диапазон в реальных логах)

К сожалению, узнать конкретные адреса порой довольно трудно, т.к. система постоянно обновляется(ну или у нас руки не из того места)

### 3. Фильтрация логов

- Если источник запроса (client IP в `query.log`) попадает в один из этих диапазонов → это **unicast-резолвер НСДИ**.
- Если IP = `195.208.4.1` или `195.208.5.1` → это **anycast-адрес**, а не реальный сервер.

Пример строки лога BIND:

```
01-Oct-2025 13:15:23.123 client @0x7f1d12 193.223.132.81#5353 (example.com): query: example.com IN A + (46.19.65.141)
```

Здесь `193.223.132.81` → unicast-резолвер НСДИ.

### 4. Вывод результатов

- Уникальные IP из этих подсетей = список зафиксированных unicast-адресов.
- Можно посчитать количество запросов от каждого IP, чтобы построить статистику нагрузки.

---

## Практическая реализация

Пример скрипта на Python (`unicast_check.py`), который фильтрует только запросы от НСДИ:

```python
import re
import ipaddress

LOGFILE = "/var/log/named/query.log"

NSDI_NETS = [
    ipaddress.ip_network("193.232.147.0/24"),
    ipaddress.ip_network("193.232.253.0/24"),
    ipaddress.ip_network("195.208.4.0/24"),
    ipaddress.ip_network("195.208.5.0/24"),
    ipaddress.ip_network("195.208.6.0/24"),
    ipaddress.ip_network("195.208.7.0/24"),
    ipaddress.ip_network("193.223.132.0/24"),
]

LOG_RE = re.compile(r"client @\S+ (\S+)#")

def ip_in_nsdi(ip_str):
    try:
        ip = ipaddress.ip_address(ip_str)
        return any(ip in net for net in NSDI_NETS)
    except ValueError:
        return False

def filter_log():
    with open(LOGFILE, "r", encoding="utf-8", errors="ignore") as f:
        for line in f:
            m = LOG_RE.search(line)
            if m:
                ip = m.group(1)
                if ip_in_nsdi(ip):
                    print(line.strip())

if __name__ == "__main__":
    filter_log()
```

---
